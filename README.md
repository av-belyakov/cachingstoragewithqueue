# Пакет cachingstoragewithqueue

Пакет 'cachingstoragewithqueue' реализует кэширующее хранилище произвольных объектов
с очередью и обработкой этих объектов в автоматическом режиме. Концептуально,
хранилище состоит из двух частей. Часть, в которой организована очередь
(далее - 'Очередь') из объектов подлежащих обработки и часть обеспечивающая временное
хранение обрабатываемых объектов и объектов которые уже были обработаны
(далее - 'Кэш').

'Очередь', хранит объекты требующие обработки. Объекты в очередь добавляются пользователем,
количество добавляемых объектов для пользователя не ограничено и ограничивается только
размером ОЗУ вычислительной машины.

В 'Кэш', объекты добавляются в автоматически. Есть следующие опции настройки:

- Интервал времени обработки очередей и объектов в 'Кэше' задается с помощью опциональной
  функции WithTimeTick(<секунды>), где допустимый интервал от 3 до 120 секунд. Если данный
  параметр не задан, то по умолчанию используется значение 5 секунд.
- Размер 'Кэша' устанавливается параметром WithMaxSize(<количество_объектов>). Размер
  'Кэша' должен быть в диапазоне от 3 до 1000 хранимых объектов. Основная задача
  'Кэша', хранить уже обработанные объекты, выполнять поиск в 'Кэше' только что принятых
  из очереди объектов, с целью обнаружения дубликатов и сравнение объектов, найденных по id.
  Если, в результате поиска будет найден объект с таким же id, то выполняется его полное
  сравнение и если объекты совпадают, объект принятый из очереди будет отброшен. Если,
  объект не совпадает, то объект из 'Кэша' будет заменён новым объектом.
- Допустимое время хранение объектов в 'Кэше' устанавливается параметром WithMaxTtl(<секунды>).
  Диапазон данного параметра от 300 до 86400 секунд. Значение по умолчанию составляет
  3600 секунд.

Обработка объектов может выполнятся как в синхронном так и в асинхронном режиме. В
синхронном режиме объекты обрабатываются по очереди, от самого старого объекта, время
жизни 'timeExpiry' которого наименьшее к самому новому. При асинхронном режиме объекты
запускаются на выполнение группами в количестве задаваемом параметром
WithEnableAsyncProcessing(<количество_объектов>) и при наличии объектов ожидающих в
очереди. Асинхронный режим включается только если значение заданное WithEnableAsyncProcessing
составляет 2 и более.

Объекты удаляются из 'Кэша' только в двух случаях:

1. По истечении времени жизни объекта.
2. При совпадении следующих условий:

- количество объектов в 'Кэше' превышает значение установленное параметром WithMaxSize;
- исполняемая функция объекта была успешно выполнена или количество попыток выполнения
  исполняемой функции превышает 3;
- объект должен иметь минимальное время жизни из всех объектов находящихся в 'Кэше'

Для использования пакета необходимо создать любой вспомогательный пользовательский тип
который реализует интерфейс CacheStorageHandler обладающий следующими методами:

```golang
type CacheStorageHandler[T any] interface {
  GetID() string
  GetFunc() func(int) bool
  GetObject() T
  SetID(string)
  SetFunc(func(int) bool)
  SetObject(T)
  Comparison(T) bool
}
```

Метод Comparison(T) выполняет задачу по сравнению двух объектов, заданных через SetObject(T).
T any может быть любой пользовательский тип соответствующий определенному интерфейсу. Например,
как в примере пакета это интерфейс SpecialObjectComparator. Или соответствовать определённому
типу, например, objectsmispformat.ListFormatsMISP.
Таким образом, пакет, может хранить и работать с любыми пользовательскими типами.

### Инициализация нового хранилища

Конструктор хранилища:

```golang
cache, err := cachingstoragewithqueue.NewCacheStorage[T any](
	cachingstoragewithqueue.WithMaxTtl[T any](300),
	cachingstoragewithqueue.WithTimeTick[T any](3),
	cachingstoragewithqueue.WithMaxSize[T any](10),
	cachingstoragewithqueue.WithEnableAsyncProcessing[T any](4))
```

При инициализации можно усановить следующие необязательные опции:

1. WithMaxTtl - устанавливает максимальное время, по истечении которого запись в cacheStorages
   будет удалена, допустимый интервал времени хранения записи от 300 до 86400 секунд;
2. WithTimeTick - устанавливает интервал времени, заданное время такта, по истечении
   которого запускается новый виток автоматической обработки содержимого кэша, интервал
   значений должен быть в диапазоне от 3 до 120 секунд;
3. WithMaxSize - устанавливает максимальный размер кэша, не может быть меньше 3 и больше
   1000 хранимых объектов кроме того, размер кэша должен минимум в ДВА раза первышать количество
   асинхронных потоков выполнения, если асинхронный режим активирован;
4. WithLogging - устанавливает обработчик для записи информационных сообщений поступающих
   от модуля. Принимаемое значение должно соответствовать интерфейсу с едиственным методом
   Write(msgType, msg string) bool;
5. WithEnableAsyncProcessing - устанавливает асинхронное выполнение функций в кэша, при
   этом асинхронное выполнение будет активировано только если количество потоков, заданных
   через эту функцию, будут два и более. Максимальное количество потоков должно быть меньше
   размер кэша как минимум в ДВА раза. Например, если количество потоков 4, размер кэша не
   может быть меньше 8.

### Запуск автоматической обработки объектов, поступающих в очередь

После инициализации хранилища запуск автоматической обработки объектов добавляемых в
очередь, не происходит. Для того что бы это произошло нужно запустить дополнительный метод:

```golang
cache.StartAutomaticExecution(ctx)
```

При активации автоматической обработки объектов, обеспечивается обработка объектов
которые добавляют в очередь. При этом модуль выполняет обработку, хранение заданного
максимального количества объектов, сравнение их на наличие дубликатов и удаление
старых объектов, срок жизни которых истёк или которые были успешно выполнены.

### Добавление объекта в очередь на обработку

Для добавления объекта в очередь нужно использовать любой вспомогательный объект
который реализует интерфейс CacheStorageHandler[T any]. Например, используем
пользовательский тип SpecialObjectForCache со вспомогательным интерфейсом
SpecialObjectComparator, который, в том числе реализует методы сравнения схожих
объектов для каждого из свойств объекта

**Создаем пользовательский тип и инициализируем его через конструктор:**

```golang
type SpecialObjectForCache[T SpecialObjectComparator] struct {
	object      T
	handlerFunc func(int) bool
	id          string
}

func NewSpecialObjectForCache[T SpecialObjectComparator]() *SpecialObjectForCache[T] {
	return &SpecialObjectForCache[T]{}
}
```

**Риализуем дополнительные методы, необходимые для соответствия вновь созданного типа интерфейсу CacheStorageHandler:**

```golang
func (o *SpecialObjectForCache[T]) SetID(v string) {
	o.id = v
}

func (o *SpecialObjectForCache[T]) GetID() string {
	return o.id
}

func (o *SpecialObjectForCache[T]) SetObject(v T) {
	o.object = v
}

func (o *SpecialObjectForCache[T]) GetObject() T {
	return o.object
}

func (o *SpecialObjectForCache[T]) SetFunc(f func(int) bool) {
	o.handlerFunc = f
}

func (o *SpecialObjectForCache[T]) GetFunc() func(int) bool {
	return o.handlerFunc
}

func (o *SpecialObjectForCache[T]) Comparison(objFromCache T) bool {
    //некие сравнения...

    return true
}
```

**Добавляем вспомогательный объект в очередь хранилища:**

```golang
cache.PushObjectToQueue(CacheStorageFuncHandler[T any])
```

После добавления вспомогательного объекта в очередь, основная работа выполняется автоматически внутри хранилища.
